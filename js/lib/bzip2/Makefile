# Makefile for building Bzip2 WebAssembly (streaming-capable)
# -----------------------------------------------------------
# Requirements:
#   - Emscripten installed (emcc available in PATH)
#   - Bzip2 1.0.8 source files in the same directory:
#       blocksort.c
#       huffman.c
#       crctable.c
#       randtable.c
#       decompress.c
#       bzlib.c
#
# Output:
#   bzip2.js   - ES6 module wrapper generated by Emscripten
#   bzip2.wasm - WebAssembly binary
#
# This build enables:
#   - MODULARIZE=1 (factory function)
#   - EXPORT_ES6=1 (native ES module)
#   - ENVIRONMENT=web (browser only)
#   - ALLOW_MEMORY_GROWTH=1 (heap grows dynamically)
#   - Streaming API exports:
#       BZ2_bzDecompressInit
#       BZ2_bzDecompress
#       BZ2_bzDecompressEnd
#   - malloc/free
#   - HEAPU8 / HEAP32 / HEAPU32 access from JS


# Output files
OUT_JS   = bzip2.js
OUT_WASM = bzip2.wasm

# Emscripten flags
EMFLAGS = \
  -O3 \
  -s MODULARIZE=1 \
  -s EXPORT_ES6=1 \
  -s ENVIRONMENT=web \
  -s ALLOW_MEMORY_GROWTH=1 \
  -s NO_EXIT_RUNTIME=1 \
  -s ASSERTIONS=0 \
  -s EXPORTED_FUNCTIONS='["_malloc","_free","_BZ2_bzDecompressInit","_BZ2_bzDecompress","_BZ2_bzDecompressEnd"]' \
  -s EXPORTED_RUNTIME_METHODS='["HEAPU8","HEAP32","HEAPU32"]'

# Bzip2 source files
SRC = \
  blocksort.c \
  huffman.c \
  crctable.c \
  randtable.c \
  decompress.c \
  bzlib.c

# Default target
all: $(OUT_JS)

# Build rule
$(OUT_JS): $(SRC)
	emcc $(SRC) $(EMFLAGS) -o $(OUT_JS)

# Cleanup
clean:
	rm -f $(OUT_JS) $(OUT_WASM)

.PHONY: all clean
